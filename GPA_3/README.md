# Generalized Procrustes Analysis (GPA) Module III

## Exporting data for Analysis in R 
You can get your morphometrics data from SlicerMorph into R in two ways:

1. You can use the SlicerMorphs GPA aligned coordinates directly into your allometric regression model or any other shape analysis.
2. You can use the original landmark coordinates as saved in FCSV or JSON format. 

Provided that you used identical settings across different GPA sofware (e.g., gpagen in geomorph), both options should (and will) give you identical results (within machine precision). Below is an exercise that demonstrates it using one of the sample datasets from SlicerMorph. 

### How to import FCSV and JSON files into R?

FCSV is a very simple file format. You can write your import function simply using the base R **read.csv()** function. For JSON, you will need a JSON parser library. THere are a number of them for R (e.g., jsonlite, rjson etc). We have developed two convinence functions that lets you import fiducial markups generated by Slicer into R, either from FCSV or JSON format. These might eventually turn into a SlicerMorpheR package in R, but for time being please access them through this github repository:

1. [read.markups.fcsv.R](https://github.com/muratmaga/SlicerMorph_Rexamples/blob/main/read.markups.fcsv.R)
2. [read.markups.json.R](https://github.com/muratmaga/SlicerMorph_Rexamples/blob/main/read.markups.json.R)

You can simpy use the **source()** function to call them directly from these repos. For example,

```
source("https://github.com/muratmaga/SlicerMorph_Rexamples/blob/main/read.markups.fcsv.R")
read.markups.fcsv("path_to_file")
```
will report the coordinates saved in the fcsv file as a 2D matrix. 

### Reading the GPA module LOG File
Additionally, we provide another convenience function to parse the log output (**analysis.log** file) from GPA module output. Parser saves everything necessary, including the output files as well as raw coordinates, in a large R object. You can find the function here:

3. [log_parser.R](https://github.com/muratmaga/SlicerMorph_Rexamples/blob/main/log_parser.R)

Specifically, it provides:
  * $input.path = Unix style path to input folder with landmark files.
  * $output.path = Unix stype path to the output folder created by GPA
  * $files = files included in the analysis
  * $format = format of landmark files ("fcsv" or "mrk.json")
  * $no.LM = number of landmarks original
  * $skipped = If any landmark is omitted in GPA (TRUE/FALSE) 
  * $skippedLM = Indices of skipped LMs (created only if $skipped=TRUE)
  * $scale = are data scaled by centroid sizes (TRUE/FALSE)
  * $MeanShape = filename that contains mean shape coordinates calculated by GPA (csv format)
  * $eigenvalues = filename that contains eigenvalues as calculated by PCA in the SlicerMorph GPA (csv format)
  * $eigenvectors = filename that contains eigenvectors as calculated by PCA in the SlicerMorph GPA (csv format)
  * $OutputData = filename that contains procrustes distances, centroid sizes and procrustes aligned coordinates as calculated by the SlicerMorph GPA (csv format)
  * $pcScores = filename that contains individal PC scores of specimens as calculated by PCA in the SlicerMorph GPA (csv format)
  * $ID = list of specimen identifiers (obtained from file names)
  * $LM = 3D landmark array that contains the 3D raw coordinates as inputed to the SlicerMorph GPA module. 
  * $semi = If any landmarks are tagged as semi-landmarks (TRUE/FALSE)
  * $semiLM = indices of LMs tagged as semi-landmarks (created only if $semi==TRUE)
  
These three functions provide everything you need to get SlicerMorph data into R; regardless if it is raw coordinates, or output from GPA module. 

## Example R analysis
Now, we will go through a R markdown document that will use the parser() function above to import data into R and fit an allometric regression model to both raw coordinates as well and GPA aligned procrustes coordinates. To do the next steps in tutorial, you have to complete these two steps:

1. Use the GPA module to run GPA/PCA analysis on the Gorilla skull landmark dataset available in the `Sample Data` module. You can refer to the instructions in [GPA I: Basics of GPA Fitting](../GPA_1/README.md) for details on using this module. Make a note of the output folder you specified. You will need to enter this into the R.
2. [Download this R markdown document and open in Rstudio](https://raw.githubusercontent.com/muratmaga/SlicerMorph_Rexamples/main/Geomorph_regression.Rmd) 

Continue following the instructions in the R Markdown document. 

